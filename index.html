<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FF Trusted | SG Marketplace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000;
            color: #f3f4f6;
            overflow-x: hidden;
        }

        .premium-card {
            background: linear-gradient(145deg, #18181b, #09090b);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .premium-card:hover {
            border-color: rgba(234, 179, 8, 0.5);
            transform: translateY(-4px);
        }

        .glass-nav {
            background: rgba(9, 9, 11, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Mobile Device Frame Styling */
        .device-frame {
            position: relative;
            border: 8px solid #18181b;
            border-radius: 2rem;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .device-notch {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40%;
            height: 18px;
            background: #18181b;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            z-index: 10;
        }

        input, select, textarea {
            background-color: #000 !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #eab308 !important;
            outline: none;
        }

        .loader {
            border: 2px solid #18181b;
            border-top: 2px solid #eab308;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #eab308; }
    </style>
</head>
<body class="min-h-screen">

    <!-- Navigation -->
    <nav class="glass-nav fixed top-0 w-full z-50">
        <div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer" onclick="showView('marketplace')">
                <div class="bg-yellow-500 p-2 rounded-xl">
                    <i class="fas fa-shopping-bag text-black"></i>
                </div>
                <h1 class="text-2xl font-black italic tracking-tighter">FF<span class="text-yellow-500">TRUSTED</span></h1>
            </div>

            <div class="flex gap-6 items-center">
                <button onclick="showView('marketplace')" id="nav-market" class="text-xs font-black uppercase tracking-widest text-yellow-500 transition">Market</button>
                <div id="admin-controls" class="hidden flex items-center gap-6">
                    <button onclick="showView('admin')" id="nav-admin" class="text-xs font-black uppercase tracking-widest text-gray-500 transition flex items-center gap-2">
                        <i class="fas fa-shield-halved"></i> Dashboard
                    </button>
                    <button onclick="handleLogout()" class="text-gray-600 hover:text-red-500 transition"><i class="fas fa-sign-out-alt"></i></button>
                </div>
                <button id="nav-login" onclick="showView('auth')" class="bg-yellow-500 text-black px-6 py-2 rounded-full font-black text-xs uppercase tracking-widest hover:scale-105 transition">Login</button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-6 pt-32 pb-20">
        
        <!-- Marketplace View -->
        <section id="view-marketplace" class="animate-in fade-in duration-700">
            <div class="flex flex-col md:flex-row justify-between items-end mb-16 gap-4">
                <div class="space-y-2">
                    <h2 class="text-5xl md:text-7xl font-black italic tracking-tighter uppercase leading-none">SG MARKET</h2>
                    <p class="text-gray-500 text-sm font-bold tracking-widest">VERIFIED GARENA FREE FIRE ACCOUNTS • SINGAPORE REGION</p>
                </div>
                <div class="bg-zinc-900 border border-white/5 px-6 py-3 rounded-full flex items-center gap-3 text-[10px] font-black tracking-widest uppercase">
                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    <span id="count-badge">0 Accounts Live</span>
                </div>
            </div>

            <div id="listings-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Data injected here -->
            </div>
            <div id="empty-state" class="hidden py-32 text-center border-2 border-dashed border-white/5 rounded-[3rem]">
                <p class="text-gray-600 font-black uppercase tracking-widest italic">Inventory Empty</p>
            </div>
        </section>

        <!-- Details View -->
        <section id="view-details" class="hidden animate-in fade-in duration-500">
            <div id="details-container" class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                <!-- Data injected here -->
            </div>
        </section>

        <!-- Auth View -->
        <section id="view-auth" class="hidden animate-in fade-in duration-500">
            <div class="max-w-md mx-auto mt-10 bg-zinc-900 p-10 rounded-[2.5rem] border border-white/5 shadow-2xl">
                <h2 id="auth-title" class="text-3xl font-black mb-8 text-center italic uppercase">Admin Access</h2>
                <form id="auth-form" class="space-y-4">
                    <input type="email" id="auth-email" placeholder="EMAIL ADDRESS" required class="w-full rounded-2xl p-4 text-xs font-bold uppercase tracking-widest">
                    <input type="password" id="auth-password" placeholder="PASSWORD" required class="w-full rounded-2xl p-4 text-xs font-bold uppercase tracking-widest">
                    <button type="submit" class="w-full bg-yellow-500 text-black font-black py-4 rounded-2xl hover:scale-[1.02] transition uppercase tracking-widest text-xs">Continue</button>
                </form>
                <p id="auth-error" class="text-red-500 text-[10px] font-bold uppercase mt-4 text-center hidden"></p>
                <button onclick="toggleAuthMode()" id="auth-toggle" class="w-full mt-6 text-gray-500 text-[10px] font-black uppercase tracking-widest hover:text-white transition">Need an admin account? Register</button>
            </div>
        </section>

        <!-- Admin View -->
        <section id="view-admin" class="hidden animate-in fade-in duration-500">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-zinc-900 p-8 rounded-[2.5rem] border border-white/5">
                        <h2 class="text-xl font-black mb-6 italic uppercase flex items-center gap-2">
                            <i class="fas fa-plus text-yellow-500"></i> New Account
                        </h2>
                        <form id="listing-form" class="space-y-4">
                            <input type="text" id="form-title" placeholder="ACCOUNT TITLE" required class="w-full rounded-2xl p-4 text-xs font-bold uppercase">
                            <div class="grid grid-cols-2 gap-4">
                                <input type="number" id="form-price" placeholder="PRICE (SGD)" required class="w-full rounded-2xl p-4 text-xs font-bold">
                                <input type="number" id="form-level" placeholder="LEVEL" required class="w-full rounded-2xl p-4 text-xs font-bold">
                            </div>
                            
                            <!-- Enhanced Image Input Section -->
                            <div class="relative aspect-video bg-black rounded-2xl border border-dashed border-white/10 overflow-hidden group">
                                <img id="img-preview" src="" class="hidden w-full h-full object-cover">
                                <div id="img-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-gray-700 font-black text-[10px] tracking-widest">
                                    <i class="fas fa-image text-3xl mb-2"></i> SELECT OR GEN IMAGE
                                </div>
                                
                                <div class="absolute bottom-2 right-2 flex gap-2">
                                    <label class="bg-white/10 hover:bg-white/20 text-white px-3 py-2 rounded-xl font-black text-[10px] flex items-center gap-2 cursor-pointer transition">
                                        <i class="fas fa-upload"></i> FROM DEVICE
                                        <input type="file" id="file-upload" accept="image/*" class="hidden">
                                    </label>
                                    <button type="button" id="btn-gen-image" class="bg-yellow-500 text-black px-3 py-2 rounded-xl font-black text-[10px] flex items-center gap-2">
                                        <span id="gen-loader" class="loader hidden"></span>
                                        <i class="fas fa-sparkles"></i> AI GEN
                                    </button>
                                </div>
                            </div>

                            <select id="form-rank" class="w-full rounded-2xl p-4 text-xs font-bold uppercase">
                                <option>Heroic</option>
                                <option>Grandmaster</option>
                                <option>Master</option>
                                <option>Diamond</option>
                            </select>
                            <textarea id="form-desc" placeholder="SKINS & DETAILS..." class="w-full rounded-2xl p-4 text-xs font-bold h-32 uppercase"></textarea>
                            <button type="submit" class="w-full bg-white text-black font-black py-4 rounded-2xl hover:bg-yellow-500 transition uppercase tracking-widest text-xs">Publish to Marketplace</button>
                        </form>
                    </div>
                </div>

                <div class="lg:col-span-2">
                    <div class="bg-zinc-900 rounded-[2.5rem] border border-white/5 overflow-hidden">
                        <div class="p-6 border-b border-white/5 bg-black/20 font-black italic tracking-widest text-[10px] uppercase">Live Database Sync</div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-xs">
                                <thead>
                                    <tr class="text-gray-500 uppercase tracking-widest border-b border-white/5">
                                        <th class="p-6">Account Listing</th>
                                        <th class="p-6">Price</th>
                                        <th class="p-6 text-right">Delete</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-table-body" class="divide-y divide-white/5">
                                    <!-- Data injected here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <footer class="mt-20 border-t border-white/5 p-12 text-center">
        <p class="text-[10px] font-black text-gray-700 uppercase tracking-[0.4em] italic mb-4">Secured by Cloud Firestore & 2FA Verification</p>
        <div class="flex justify-center gap-6 text-gray-800">
            <i class="fab fa-discord hover:text-white cursor-pointer transition"></i>
            <i class="fab fa-instagram hover:text-white cursor-pointer transition"></i>
            <i class="fab fa-telegram hover:text-white cursor-pointer transition"></i>
        </div>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut,
            signInAnonymously,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            onSnapshot, 
            addDoc, 
            deleteDoc, 
            doc 
        } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : { projectId: "acc-seller-trusted" }; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'acc-seller-trusted';
        const apiKey = ""; 

        let currentUser = null;
        let accounts = [];
        let authMode = 'login';
        let currentImageBase64 = '';
        let unsubscribeDataSync = null;

        window.showView = (viewName) => {
            const views = ['marketplace', 'details', 'auth', 'admin'];
            views.forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
                const navBtn = document.getElementById(`nav-${v}`);
                if (navBtn) navBtn.classList.replace('text-yellow-500', 'text-gray-500');
            });
            
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            const activeNav = document.getElementById(`nav-${viewName}`);
            if (activeNav) activeNav.classList.replace('text-gray-500', 'text-yellow-500');
            
            window.scrollTo(0, 0);
        };

        window.toggleAuthMode = () => {
            authMode = authMode === 'login' ? 'register' : 'login';
            document.getElementById('auth-title').innerText = authMode === 'login' ? 'Admin Access' : 'Create Admin';
            document.getElementById('auth-toggle').innerText = authMode === 'login' 
                ? 'Need an admin account? Register' 
                : 'Already registered? Login';
        };

        const initDataSync = (user) => {
            if (!user) return;
            if (unsubscribeDataSync) unsubscribeDataSync();

            const listingsRef = collection(db, 'artifacts', appId, 'public', 'data', 'listings');
            unsubscribeDataSync = onSnapshot(listingsRef, (snapshot) => {
                accounts = snapshot.docs.map(d => ({ id: d.id, ...d.data() }))
                                    .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                renderMarketplace();
                renderAdminTable();
                document.getElementById('count-badge').innerText = `${accounts.length} Accounts Live`;
            }, (error) => {
                console.error("Firestore sync error:", error);
            });
        };

        const renderMarketplace = () => {
            const grid = document.getElementById('listings-grid');
            const empty = document.getElementById('empty-state');
            
            if (accounts.length === 0) {
                grid.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }

            grid.classList.remove('hidden');
            empty.classList.add('hidden');
            
            grid.innerHTML = accounts.map(acc => `
                <div onclick="showDetails('${acc.id}')" class="group premium-card rounded-[2.5rem] overflow-hidden cursor-pointer">
                    <div class="relative aspect-[9/12] m-4">
                        <!-- Mobile Device Frame Wrapper -->
                        <div class="device-frame h-full w-full">
                            <div class="device-notch"></div>
                            ${acc.mainImageUrl 
                                ? `<img src="${acc.mainImageUrl}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700">`
                                : `<div class="w-full h-full bg-zinc-900 flex items-center justify-center"><i class="fas fa-camera text-white/10 text-4xl"></i></div>`
                            }
                            <div class="absolute top-8 right-4 bg-black/80 px-3 py-1 rounded-full text-[10px] font-black border border-white/10 uppercase z-20">LVL ${acc.level}</div>
                            <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-80 z-10"></div>
                            <div class="absolute bottom-6 left-6 z-20">
                                <span class="bg-yellow-500 text-black text-[9px] font-black px-2 py-0.5 rounded uppercase mb-2 inline-block">${acc.rank}</span>
                                <h3 class="text-xl font-black italic uppercase leading-none truncate w-40">${acc.title}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="px-6 py-4 flex justify-between items-center bg-zinc-900/40 border-t border-white/5">
                        <span class="text-2xl font-black text-white italic">$${acc.price}</span>
                        <div class="bg-white/5 p-3 rounded-2xl group-hover:bg-yellow-500 transition-colors group-hover:text-black">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                    </div>
                </div>
            `).join('');
        };

        const renderAdminTable = () => {
            const tbody = document.getElementById('admin-table-body');
            tbody.innerHTML = accounts.map(acc => `
                <tr class="hover:bg-white/[0.02] transition-colors">
                    <td class="p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-black border border-white/10 overflow-hidden">
                                <img src="${acc.mainImageUrl || ''}" class="w-full h-full object-cover">
                            </div>
                            <div>
                                <div class="font-black uppercase text-sm">${acc.title}</div>
                                <div class="text-[10px] text-gray-500 uppercase tracking-widest">LVL ${acc.level} • ${acc.rank}</div>
                            </div>
                        </div>
                    </td>
                    <td class="p-6 font-black text-yellow-500">$${acc.price}</td>
                    <td class="p-6 text-right">
                        <button onclick="handleDeleteListing('${acc.id}')" class="text-gray-600 hover:text-red-500 transition-colors p-2">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        };

        window.showDetails = (id) => {
            const acc = accounts.find(a => a.id === id);
            if (!acc) return;
            
            const container = document.getElementById('details-container');
            container.innerHTML = `
                <div class="space-y-6">
                    <button onclick="showView('marketplace')" class="flex items-center gap-2 text-gray-500 hover:text-white transition font-black text-[10px] uppercase tracking-widest mb-4">
                        <i class="fas fa-chevron-left"></i> Back to Listings
                    </button>
                    <div class="max-w-xs mx-auto">
                        <div class="device-frame aspect-[9/16]">
                            <div class="device-notch"></div>
                            <img src="${acc.mainImageUrl || ''}" class="w-full h-full object-cover">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4 font-black italic uppercase">
                        <div class="bg-zinc-900 p-6 rounded-3xl border border-white/5 text-center">
                            <div class="text-[10px] text-gray-600 mb-1">Level</div>
                            <div class="text-2xl">${acc.level}</div>
                        </div>
                        <div class="bg-zinc-900 p-6 rounded-3xl border border-white/5 text-center">
                            <div class="text-[10px] text-gray-600 mb-1">Rank</div>
                            <div class="text-2xl text-yellow-500">${acc.rank}</div>
                        </div>
                        <div class="bg-zinc-900 p-6 rounded-3xl border border-white/5 text-center">
                            <div class="text-[10px] text-gray-600 mb-1">Region</div>
                            <div class="text-2xl">SG</div>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col justify-center">
                    <h2 class="text-5xl md:text-6xl font-black italic tracking-tighter mb-4 uppercase leading-none">${acc.title}</h2>
                    <div class="text-6xl font-black text-yellow-500 mb-8 italic">$${acc.price}</div>
                    <div class="bg-zinc-900/50 p-8 rounded-[2.5rem] border border-white/5 italic text-gray-400 leading-relaxed mb-8">
                        ${acc.description || "Premium Singapore region account with verified 2FA and rare item history."}
                    </div>
                    <button onclick="alert('Proceeding to secure escrow agent...')" class="w-full bg-yellow-500 text-black font-black py-6 rounded-2xl hover:scale-[1.02] transition shadow-[0_0_50px_rgba(234,179,8,0.1)] uppercase tracking-widest">Buy Now</button>
                </div>
            `;
            showView('details');
        };

        // File Upload Handler
        document.getElementById('file-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    currentImageBase64 = event.target.result;
                    const preview = document.getElementById('img-preview');
                    preview.src = currentImageBase64;
                    preview.classList.remove('hidden');
                    document.getElementById('img-placeholder').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('auth-form').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const errorEl = document.getElementById('auth-error');
            
            try {
                if (authMode === 'register') {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
                showView('marketplace');
            } catch (err) {
                errorEl.innerText = err.message.toUpperCase();
                errorEl.classList.remove('hidden');
            }
        };

        window.handleLogout = () => signOut(auth);

        document.getElementById('listing-form').onsubmit = async (e) => {
            e.preventDefault();
            if (!currentUser || currentUser.isAnonymous) return alert("Please login with admin credentials.");
            
            const newListing = {
                title: document.getElementById('form-title').value,
                price: document.getElementById('form-price').value,
                level: document.getElementById('form-level').value,
                rank: document.getElementById('form-rank').value,
                description: document.getElementById('form-desc').value,
                mainImageUrl: currentImageBase64,
                createdAt: Date.now(),
                sellerId: currentUser.uid
            };

            try {
                const col = collection(db, 'artifacts', appId, 'public', 'data', 'listings');
                await addDoc(col, newListing);
                document.getElementById('listing-form').reset();
                document.getElementById('img-preview').classList.add('hidden');
                document.getElementById('img-placeholder').classList.remove('hidden');
                currentImageBase64 = '';
                alert("Account Published Successfully");
            } catch (err) { alert(err.message); }
        };

        window.handleDeleteListing = async (id) => {
            if (!confirm("Delete this listing?")) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'listings', id));
            } catch (err) { alert(err.message); }
        };

        document.getElementById('btn-gen-image').onclick = async () => {
            const title = document.getElementById('form-title').value;
            const rank = document.getElementById('form-rank').value;
            if (!title) return alert("Enter account title first!");

            const loader = document.getElementById('gen-loader');
            loader.classList.remove('hidden');

            try {
                const prompt = `Garena Free Fire professional character skin with ${rank} rank badge, mobile game screenshot style, high quality render, showcasing ${title}`;
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ instances: { prompt }, parameters: { sampleCount: 1 } })
                });
                
                const result = await response.json();
                if (result.predictions?.[0]?.bytesBase64Encoded) {
                    currentImageBase64 = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    const preview = document.getElementById('img-preview');
                    preview.src = currentImageBase64;
                    preview.classList.remove('hidden');
                    document.getElementById('img-placeholder').classList.add('hidden');
                }
            } catch (err) {
                console.error("AI Generation Error:", err);
            } finally {
                loader.classList.add('hidden');
            }
        };

        const initializeFirebase = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const adminControls = document.getElementById('admin-controls');
            const loginBtn = document.getElementById('nav-login');
            
            if (user) {
                initDataSync(user);
                if (!user.isAnonymous) {
                    adminControls.classList.remove('hidden');
                    loginBtn.classList.add('hidden');
                } else {
                    adminControls.classList.add('hidden');
                    loginBtn.classList.remove('hidden');
                    if (!document.getElementById('view-admin').classList.contains('hidden')) {
                        showView('marketplace');
                    }
                }
            }
        });

        window.onload = () => {
            initializeFirebase();
        };

    </script>
</body>
</html>
